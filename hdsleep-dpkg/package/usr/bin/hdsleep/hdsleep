#!/bin/bash

LOCK_FILE=/tmp/hdsleep.lock
CONFIG_FILE=/etc/hdsleep/config.cfg

. $CONFIG_FILE

if [ -z $disk ]; then
	echo "Missing disk configuration. Edit $CONFIG_FILE with the necessary disk value."
	exit 1
fi
if [ -z $mode ]; then
	mode="standby"
fi

usage(){
	echo Sends command to the given hdd to go to standby or sleep mode.
	echo
	echo "Usage: $(basename $0) hdd (standby|sleep)"
	exit 1
}

if [ ! -e $disk ]; then
	usage
fi

# get hdd activity
cpu=$(/usr/bin/hdsleep/hdusage)

if [ $cpu -eq 0 ]; then
    # exit if lock file found
    if [ -e $LOCK_FILE ]; then exit 0; fi

    logger "No activity in hdd $disk."
    
    case $mode in
        standby)
            logger "Bring $disk to $mode mode."
            hdparm -y $disk
            ;;    
        sleep)
            logger "Bring $disk to $mode mode."
            hdparm -Y $disk
            ;;
        *)
            echo "Missing hdd stop mode."
            exit 1
            ;;
    esac    
    echo $(date) > $LOCK_FILE
else
    logger "Current cpu activity in hdd $disk: $cpu"
    rm -f $LOCK_FILE
fi
